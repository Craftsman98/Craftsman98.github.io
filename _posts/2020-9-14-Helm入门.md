**使用Helm的先决条件**

1. 安装了一个Kubernetes集群
   Helm对Kubernetes的版本倾斜策略是：在Helm3中与它针对其编译的**n-3**版本的Kubernetes兼容；在Helm2中为**n-1**个版本。
   <img src="Helm%E5%85%A5%E9%97%A8.assets/1599095762517.png" alt="1599095762517" style="zoom: 67%;" />
2. 如果有的话，确定想要使用的安全策略
3. 安装并配置Helm

## 安装Helm

### 二进制安装

1. 从 https://github.com/helm/helm/releases 选择希望安装的Helm版本并下载其对应操作系统的二进制文件
2. 解压文件 tar -zxvf helm-v3.0.0-linux-amd64.tar.gz 
3. 移动目录 mv linux-amd64/helm /usr/local/bin/helm 

### 脚本安装

```sh
$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
$ chmod 700 get_helm.sh
$ ./get_helm.sh
```

## 使用Helm

### 重要概念介绍

Helm向kubernetes安装charts，并且为每次安装创建新的release。可以在Helm chart repository中寻找新的chart。

* **Chart** 是一个Helm安装包，它包含了在Kubernetes中运行应用、工具或服务所需要的全部必要资源定义。就像是 Yum RPM file
* **Repository** 是收集和分享chart的仓库。
* **Release** 是一个运行在Kubernetes集群中的Chart实例。一个Chart可以被很多次的安装到同一个集群中，每次安装都会创建一个新的Release。

### helm search

* `helm search hub` 在Helm Hub上面查找，Helm Hub包含了 来自几十个不同仓库的Helm Chart。
* `helm serch repo` 在添加到本地Helm客户端的仓库中查找，使用`helm repo add`添加仓库

helm search 使用了模糊字符串匹配算法，可以进行模糊搜索

### helm install

使用`helm install`安装，最简单的情况需要两个参数：release name和希望安装的chart

```sh
$ helm install happy-panda stable/mariadb
WARNING: This chart is deprecated
NAME: happy-panda
LAST DEPLOYED: Fri May  8 17:46:49 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
This Helm chart is deprecated

...

Services:

  echo Master: happy-panda-mariadb.default.svc.cluster.local:3306
  echo Slave:  happy-panda-mariadb-slave.default.svc.cluster.local:3306

Administrator credentials:

  Username: root
  Password : $(kubectl get secret --namespace default happy-panda-mariadb -o jsonpath="{.data.mariadb-root-password}" | base64 --decode)

To connect to your database:

  1. Run a pod that you can use as a client:

      kubectl run happy-panda-mariadb-client --rm --tty -i --restart='Never' --image  docker.io/bitnami/mariadb:10.3.22-debian-10-r27 --namespace default --command -- bash

  2. To connect to master service (read/write):

      mysql -h happy-panda-mariadb.default.svc.cluster.local -uroot -p my_database

  3. To connect to slave service (read-only):

      mysql -h happy-panda-mariadb-slave.default.svc.cluster.local -uroot -p my_database

To upgrade this helm chart:

  1. Obtain the password as described on the 'Administrator credentials' section and set the 'rootUser.password' parameter as shown below:

      ROOT_PASSWORD=$(kubectl get secret --namespace default happy-panda-mariadb -o jsonpath="{.data.mariadb-root-password}" | base64 --decode)
      helm upgrade happy-panda stable/mariadb --set rootUser.password=$ROOT_PASSWORD

```

安装后如果希望获取某个release的状态，使用`helm status `查看。

#### 安装前自定义

使用`helm show values`查看chart配置

* 可以使用Yaml配置文件覆盖values设置，`--values`或`-f`来声明，可以多次指定，排在最右边的声明优先级最高

```sh
$ echo '{mariadbUser: user0, mariadbDatabase: user0db}' > config.yaml
$ helm install -f config.yaml stable/mariadb --generate-name
```

* 在命令行声明覆盖的值`--set`

如果上面的两种方式混合使用，那么`--set`的值会以更高优先级合并到`--values`中。使用`--set`声明的覆盖会被持久化到ConfigMap中。可以使用`helm get values <release-name>`查看覆盖的值。可以使用`helm upgrate`并声明`--reset-values`来清除`--set`声明的值。

#### `--set` 的规范和限制



#### 更多的安装方式

* 通过本地chart压缩文件 ` helm install foo foo-0.1.1.tgz `
* 通过未压缩的chart目录 ` helm install foo path/to/foo `
* 通过完整的URL ` helm install foo https://example.com/charts/foo-1.2.3.tgz `

### helm upgrade 和 helm rollback

helm upgrade 使用最小的升级，只会升级与上一次release不同的部分。

下面是panda.yaml

```yaml
mariadbUser: user1
```

升级过程

```sh
$ helm upgrade -f panda.yaml happy-panda stable/mariadb
Fetched stable/mariadb-0.3.0.tgz to /Users/mattbutcher/Code/Go/src/helm.sh/helm/mariadb-0.3.0.tgz
happy-panda has been upgraded. Happy Helming!
Last Deployed: Wed Sep 28 12:47:54 2016
Namespace: default
Status: DEPLOYED
...
```

如果升级发生问题，可以使用` helm rollback [RELEASE] [REVISION] `进行回滚

每次进行安装、升级或回滚操作的时候，版本号（revision）就会增加1。第一个版本号永远是1。可以使用`helm history [RELEASE]`查看某个release的版本号历史。

### Install/Upgrade/Rollback设置

* `--timeout` 等待kubernetes命令完成的时间，默认是5m0s
* `--wait` 等待所有的Pod处于ready状态，PVC都被绑定，Deployment有最小数量（预期减去最大不可用）的pod在ready状态并且Service都有一个IP地址（如果是负载均衡器，还需要有Ingress），满足上述要求后标记这个release为成功（successful）。  它将等待`--timeout`值。 如果达到超时，该release将被标记为FAILED 
* `--no-hooks` 跳过运行该命令的hook
* `--recreate-pods` （只对update和rollback有效）会使所有的pod被重新创建（在Helm3中被弃用）

### helm uninstall

```sh
$ helm uninstall happy-panda
```

在之前的版本中，删除release后会保留这个删除记录。 在Helm 3中，删除也会删除release记录。如果你想要保留一个删除release记录，使用`helm uninstall --keeping-history`。使用`helm list --uninstalled`将只显示已卸载的版本，并带有`--keep history`标志。 

### helm repo

Helm 3不再使用默认的chart仓库。`helm repo`命令组提供用于添加、列出和删除仓库的命令。 

* ` helm repo list `列出已经配置了哪些仓库
* ` helm repo add ` 添加一个新的仓库
* ` helm repo update ` 确保仓库保持在最新状态
* ` helm repo remove ` 移除仓库

## Charts介绍

一个chart是一系列用来描述Kubernetes资源的文件集合。Chart在一个特定的目录树中作为文件被创建，它们可以被打包到版本化的压缩包中以用来部署。

### Chart 文件结构

一个Chart是在一个目录中被组织成为一个集合的文件，目录的名称就是chart的名称（没有版本信息）。目录内部的结构会像下面这样：

```sh
wordpress/
  Chart.yaml          # 包含了chart信息的Yaml文件
  LICENSE             # 可选：包含了chart证书的纯文本文件
  README.md           # 可选：人类可读的README文件
  values.yaml         # 对这个chart默认的配置值
  values.schema.json  # OPTIONAL: A JSON Schema for imposing a structure on the values.yaml file
  charts/             # 一个包含了这个chart所需要的所有chart的目录
  crds/               # Custom Resource Definitions
  templates/          # 模板目录，与values相结合生成kubernetes manifest文件
  templates/NOTES.txt # 可选:包含简短用法说明的纯文本文件
```

### Chart.yaml

```yaml
apiVersion: The chart API version (required)
name: The name of the chart (required)
version: A SemVer 2 version (required)
kubeVersion: A SemVer range of compatible Kubernetes versions (optional)
description: A single-sentence description of this project (optional)
type: The type of the chart (optional)
keywords:
  - A list of keywords about this project (optional)
home: The URL of this projects home page (optional)
sources:
  - A list of URLs to source code for this project (optional)
dependencies: # A list of the chart requirements (optional)
  - name: The name of the chart (nginx)
    version: The version of the chart ("1.2.3")
    repository: The repository URL ("https://example.com/charts") or alias ("@repo-name")
    condition: (optional) A yaml path that resolves to a boolean, used for enabling/disabling charts (e.g. subchart1.enabled )
    tags: # (optional)
      - Tags can be used to group charts for enabling/disabling together
    enabled: (optional) Enabled bool determines if chart should be loaded
    import-values: # (optional)
      - ImportValues holds the mapping of source values to parent key to be imported. Each item can be a string or pair of child/parent sublist items.
    alias: (optional) Alias to be used for the chart. Useful when you have to add the same chart multiple times
maintainers: # (optional)
  - name: The maintainers name (required for each maintainer)
    email: The maintainers email (optional for each maintainer)
    url: A URL for the maintainer (optional for each maintainer)
icon: A URL to an SVG or PNG image to be used as an icon (optional).
appVersion: The version of the app that this contains (optional). This needn't be SemVer.
deprecated: Whether this chart is deprecated (optional, boolean)
annotations:
  example: A list of annotations keyed by name (optional).
```

#### Chart版本控制

每个Chart都必须有版本号。必须遵循SemVer 2标准。与Helm Classic不同，Helm v2及其后续版本使用版本号作为发布标记。存储库中的包是通过名称加上版本号来标识的。 

系统假设chart包名中的版本号和Chart.yaml中的版本号相同，如果不同会发生错误。

#### `apiVersion`字段

如果chart要求至少为Helm 3 那么`apiVersion`应该为`v2`，支持之前版本的chart的`apiVersion`被设置为`v1`，也可以使用Helm 3 安装。

v1到v2的变化：

* 增加了`dependencies`字段，替换了v1版本中单独的 requirements.yaml 文件
* `type`字段区分application和library两种charts。

#### `appVersion` 字段

声明了应用程序的版本，与`version`字段无关，也不需要满足SemVer 2标准。

#### `kubeVersion`字段

可选的字段，定义SemVer约束指定支持的Kubernetes版本。Helm将在安装Chart时验证版本约束，如果集群运行不支持的Kubernetes版本，则会失败。版本约束可以包含空格和比较符号。

```sh
>= 1.13.0 < 1.15.0
```

除了操作符号 `=` `!=` `>` `<` `>=` `<=` ，还支持

* 连字符 `-` ， 1.1 - 2.3.4 
* 通配符 `x` 、`X`、`*`，  1.2.x 
* 波浪线`~`，  ~1.2.3 相当于 \>= 1.2.3 < 1.3.0 
* 插入号`^`，  ^1.2.3 相当于 \>= 1.2.3 < 2.0.0 

#### 过时Chart

标记chart过时，标记后可以用新版本的chart替代

#### `type`字段

定义了chart的类型，一共有`application`和`library`两种类型。`application`是默认的类型，是可以完全操作的标准Chart。`library`类型的chart为chart构建器提供了工具或函数，它是不可安装的，而且通常不包含任何任何的资源对象。

 注意: application chart可以用作library chart。这是通过将类型设置为library来启用的。然后，chart将被呈现为一个library chart，其中可以使用所有工具和函数。chart的所有资源对象将不会被呈现。 

#### `dependencies`字段

chart对其他chart的依赖，可以动态的链接在Chart.yaml文件的`dependencies`字段中或者导入到 charts/ 目录中进行手动管理。

##### Alias别名

为依赖设置一个别名，可以依赖多个相同的chart并为他们指定不同的别名。

```yaml
# parentchart/Chart.yaml

dependencies:
  - name: subchart
    repository: http://localhost:10191
    version: 0.1.0
    alias: new-subchart-1
  - name: subchart
    repository: http://localhost:10191
    version: 0.1.0
    alias: new-subchart-2
  - name: subchart
    repository: http://localhost:10191
    version: 0.1.0
```



##### Tags和Condition字段

```yaml
# parentchart/Chart.yaml

dependencies:
  - name: subchart1
    repository: http://localhost:10191
    version: 0.1.0
    condition: subchart1.enabled, global.subchart1.enabled
    tags:
      - front-end
      - subchart1
  - name: subchart2
    repository: http://localhost:10191
    version: 0.1.0
    condition: subchart2.enabled,global.subchart2.enabled
    tags:
      - back-end
      - subchart2
```

##### 导入子值

### Templates 和 Values

Helm Chart模板以Go模板语言编写，另外还增加了Sprig库中的50个左右的附加模板函数和一些其他专用函数。

所有模板文件都存储在图表的模板/文件夹中。 当Helm渲染图表时，它将通过模板引擎传递该目录中的每个文件。 

模板的值以两种方式提供：

* Chart开发者可能会在chart中提供一个values.yaml文件，这个文件会包含很多默认值。
* Chart用户可以提供一个包含一些值的YAML文件，这个文件可以通过命令行的方式提供：`helm install`

#### Template 文件

```yaml
apiVersion: v1
kind: ReplicationController
metadata:
  name: deis-database
  namespace: deis
  labels:
    app.kubernetes.io/managed-by: deis
spec:
  replicas: 1
  selector:
    app.kubernetes.io/name: deis-database
  template:
    metadata:
      labels:
        app.kubernetes.io/name: deis-database
    spec:
      serviceAccount: deis-database
      containers:
        - name: deis-database
          image: {{ .Values.imageRegistry }}/postgres:{{ .Values.dockerTag }}
          imagePullPolicy: {{ .Values.pullPolicy }}
          ports:
            - containerPort: 5432
          env:
            - name: DATABASE_STORAGE
              value: {{ default "minio" .Values.storage }}
```

上面这是一个replication Conrtoller 的template文件，它可以用以下的值（通常定义在Values.yaml中）

* imageRegistry: Docker 镜像的仓库源
* dockerTag: Docker镜像的Tag
* pullPolicy： 拉取策略
* storage：后端存储，默认为minio

#### 预定义的值

通过Values.yaml或者`--set`预定义的值可以提供给template中的`.Values`对象。还有一些预定义数据的方式。

下面的值是预定义的，对每个模板都可用，并且不能被覆盖，名称是区分大小写的。 

* **Release.Name** release的名字（不是chart的名字）
* **Release.Namespace** chart被发布到的命名空间
* **Release.Service** 执行发布的service
* **Release.IsUpgrade** 当前的操作是否是Upgrade或者Rollback
* **Release.IsInstall** 当前的操作是否是install
* **Chart** Chart.yaml的内容。例如可以通过`Chart.Version`获取chart的版本
* **File** 一个类似于map的对象，包含chart中的所有非特殊文件。这个预定义值不能访问templates，但是可以访问存在的附加文件（使用`.helmignore`排除的文件除外）。使用`{{index.Files"file name"}}`或`.Files.Get name`功能来访问文件。或者可以使用`{{.File.GetBytes}}`来以字节数组的形式访问文件内容
* **Capabilities** 一个类似于map的对象，包含了Kubernetes的版本信息` {{.Capabilities.KubeVersion}} `和支持的Kubernetes API 版本` {{Capabilities.APIVersions.Has "batch/v1"}} `

注意：任何位置的Chart.yaml字段都会被丢弃，在chart内部不会被访问到。因此Chart.yaml不能够用来将任意数据结构的数据传递到template中，但是值文件（Values files）可以。

#### Values files

每个chart会包含一个默认的values.yaml文件，Helm允许用户在命令行中提供额外的yaml文件来覆盖values。

```sh
$ helm install --generate-name --values=myvals.yaml wordpress
```

通过这种方式提供的值会合并到原来的values.yaml文件中

#### Scope，Dependencies，Values

一个值文件和可以为charts和任何它的依赖提供值。

```yaml
title: "My WordPress Site" # Sent to the WordPress template

mysql:
  max_connections: 100 # Sent to MySQL
  password: "secret"

apache:
  port: 8080 # Passed to Apache
```

高级的chart可以访问下面定义的所有变量，但是低级的chart不能访问父chart中的变量，也不能访问同级的变量。

值是包含在命名空间中的，但是命名空间是精简化的。在上例中WorldPress访问MySQL的password字段时，需要用`.Values.mysql.password`。但是对于MySQL这个chart，访问password时只需用`.Values.password`。

#### 全局变量

```yaml
title: "My WordPress Site" # Sent to the WordPress template

global:
  app: MyWordPress

mysql:
  max_connections: 100 # Sent to MySQL
  password: "secret"

apache:
  port: 8080 # Passed to Apache
```

上例中的global部分可以被任何chart使用`.Values.global.app`访问。

如果一个子chart中声明了一个全局变量，那么这个变量会向下传递，但是不会向上传递。父chart的全局变量优先级高于子chart中的全局变量。

#### 模式文件（Schema Files）

```json
{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "properties": {
    "image": {
      "description": "Container Image",
      "properties": {
        "repo": {
          "type": "string"
        },
        "tag": {
          "type": "string"
        }
      },
      "type": "object"
    },
    "name": {
      "description": "Service name",
      "type": "string"
    },
    "port": {
      "description": "Port",
      "minimum": 0,
      "type": "integer"
    },
    "protocol": {
      "type": "string"
    }
  },
  "required": [
    "protocol",
    "port"
  ],
  "title": "Values",
  "type": "object"
}
```

### Custom Resource Definition (CRD)

在Helm 3中，CRD被作为一种特殊的对象来看待。相对于chart的其他部分，它们被最先安装，并且受到一些规则的限制。

CRD YAML文件应放在图表内的crds /目录中。 多个CRD（由YAML起始标记和结束标记分隔）可以放在同一文件中。 Helm将尝试将CRD目录中的所有文件加载到Kubernetes中。 

 CRD文件无法模板化。 它们必须是纯YAML文档。 

 当Helm安装新chart时，它将上传CRD，暂停直到API Server可用CRD，然后启动模板引擎，渲染chart的其他部分，然后将其上传到Kubernetes。 由于此顺序，CRD信息在Helm模板的`.Capabilities`对象中可用，并且Helm模板可能会创建在CRD中声明的对象的新实例。 

#### CRD的限制

* CRD不会被重装。如果Helm认为在`/crds`目录下的CRD已经被安装（无论什么版本），那么Helm不会尝试安装或升级这个CRD。
* CRD不会在升级或回滚操作中被安装。Helm只会在安装操作中创建CRD。
* CRD不会被删除。 删除CRD将自动删除集群中所有namespace中的所有CRD内容。因此，Helm不会删除crd。 

如果希望升级CRD，建议十分小心的手动升级。

### 使用Helm管理Charts

创建新的Chart

```sh
$ helm create mychart
Created mychart/
```

编辑完成一个chart后，helm可以将其打包成chart压缩包

```sh
$ helm package mychart
Archived mychart-0.1.-.tgz
```

 你也可以使用helm来帮助你发现chart格式或信息方面的问题 

```sh
$ helm lint mychart
No issues found
```

### Chart仓库

